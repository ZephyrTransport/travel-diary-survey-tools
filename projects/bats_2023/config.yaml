# DaySim Processing Pipeline Configuration for BATS 2023
# This config file demonstrates the full pipeline with DaySim formatting

# config.yaml

# Define directory shorthands
survey_dir: "M:/Data/HomeInterview/Bay Area Travel Study 2023/Data/Full Weighted 2023 Dataset/WeightedDataset_02212025"
output_dir: "M:/Data/HomeInterview/Bay Area Travel Study 2023/Data/Processed/2023_pipeline_output"
taz_shapefile: "C:/GitHub/tm2py-utils/tm2py_utils/inputs/maz_taz/shapefiles/tazs_TM2_2_5.shp"
maz_shapefile: "C:/GitHub/tm2py-utils/tm2py_utils/inputs/maz_taz/shapefiles/mazs_TM2_2_5.shp"

# Pipeline configuration
steps:
  - name: load_data
    validate_input: false # This will override @step(validate=True/False) in the function definition
    cache: true
    params:
      input_paths:
        households: "{{ survey_dir }}/hh.csv"
        persons: "{{ survey_dir }}/person.csv"
        days: "{{ survey_dir }}/day.csv"
        unlinked_trips: "{{ survey_dir }}/trip.csv"
        taz_shapefile: "{{ taz_shapefile }}"
        maz_shapefile: "{{ maz_shapefile }}"

  - name: clean_2023_bats
    validate_input: false
    cache: true

  # - name: imputation
  #   validate_input: true

  - name: link_trips
    validate_input: false
    cache: true
    params:
      change_mode_code: 11  # Purpose code for 'change_mode'
      transit_mode_codes: [12, 13, 14] # NOTE: this is not elegant
      max_dwell_time: 180  # in minutes
      dwell_buffer_distance: 100  # in meters

  - name: detect_joint_trips
    validate_input: false
    cache: true
    params:
      config:
        method: "mahalanobis"
        # Covariance for Mahalanobis distance calculation
        # Think of this as the standard deviation of measurement noise in each dimension
        # Diagonal: [origin_var_m^2, dest_var_m^2, depart_var_min^2, arrive_var_min^2]
        # Default [10000, 10000, 100, 100] = 100m, 100m, 10min, 10min std devs
        covariance: [10000, 10000, 100, 100]
        # Confidence level: Higher = stricter matching (fewer detections)
        # 0.90 = 90% confidence (strict), 0.75 = moderate, 0.50 = permissive
        confidence_level: 0.90

        # Alternative: simpler buffer method with time/space thresholds
        # method: "buffer"
        # time_threshold_minutes: 15.0
        # space_threshold_meters: 100.0

  - name: extract_tours
    validate_input: false
    cache: true

  # - name: weighting
  #   validate_input: true
  #   cache: true

  - name: custom_add_taz_ids
    validate_input: false
    cache: true
    params:
      taz_field_name: "TAZ_NODE"  # Field name in shapefile for TAZ ID
      maz_field_name: "MAZ_NODE"  # Field name in shapefile for MAZ ID

  # - name: final_check
  #   validate_input: true

  # This prepares a new set of files formatted for DaySim
  - name: format_daysim
    validate_input: false
    cache: false
    params:
      drop_partial_tours: true
      drop_missing_taz: true
      drop_invalid_tours: true

  - name: write_data
    validate_input: true
    params:
      output_paths:
        # Standard Survey Formats
        households: "{{ output_dir }}/households.csv"
        persons: "{{ output_dir }}/persons.csv"
        days: "{{ output_dir }}/days.csv"
        unlinked_trips: "{{ output_dir }}/unlinked_trips.csv"
        linked_trips: "{{ output_dir }}/linked_trips.csv"
        tours: "{{ output_dir }}/tours.csv"
        joint_trips: "{{ output_dir }}/joint_trips.csv"
        # DaySim Formats
        households_daysim: "{{ output_dir }}/hh_daysim.csv"
        persons_daysim: "{{ output_dir }}/person_daysim.csv"
        days_daysim: "{{ output_dir }}/day_daysim.csv"
        linked_trips_daysim: "{{ output_dir }}/linked_trip_daysim.csv"
        tours_daysim: "{{ output_dir }}/tour_daysim.csv"
